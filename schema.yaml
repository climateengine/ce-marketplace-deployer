x-google-marketplace:
  schemaVersion: v2

  applicationApiVersion: v1beta1
  # The published version is required and MUST match the tag
  # of the deployer image
  publishedVersion: '1.0.5'
  publishedVersionMetadata:
    releaseNote: >-
      A first release.
  images:
    ce-deployer:
      properties:
        ce_deployer_image:
          type: FULL

  clusterConstraints:
    assistedClusterCreation:
      type: DISABLED
      creationGuidance: >-
        The cluster must be GKE Standard (not Autopilot) and have at least six (6) nodes with
        machine type "e2-medium" or larger. Climate Engine also requires other Google Cloud resources.
        See sidebar for additional requirements.

form:
- widget: help
  description: >-
    <h2>Additional Requirements</h2>
    <p>In addition to GKE, Climate Engine requires access to a Postgres 13 Cloud SQL instance, and a GCS bucket.
    These can be created automatically or manually.</p>

    <h3>Automatic Creation</h3>
    <p>If you would like these to be created automatically, the GKE instance must be preconfigure with a
    Kubernetes secret containing the JSON credentials of a Service Account with role/owner permissions.
    This can be done by running the following command:</p>
    <p>kubectl create secret generic google-cloud-key --from-file=key.json=PATH-TO-KEY-FILE.json</p>
    <p><b>Note:</b> the key or filename within the secret <em>must</em> be named key.json as shown in the
    command above.</p>
    <p>This service account can be deleted or disabled after deployment.</p>

    <h3>Manual Creation</h3>
    <p>For more advanced installations, you may choose to manually create the Cloud SQL (Postgres 13) and GCS bucket
    before installing Climate Engine. The Cloud SQL (Postgres 13) instance must be accessible from within the
    GKE cluster, and provisioned with a database and a user with read/write permissions to that database.
    The Service Account running Climate Engine must have full read/write permissions to the GCS bucket.</p>

    <h2>Configuration Help</h2>

    <h3>Create GCS bucket</h3>
    <p><b>Required.</b> Whether Climate Engine should automatically create a new Google Cloud Storage bucket.
    If not automatically creating the bucket, the GCS bucket must already exist and the GKE Service Account
    must have full read/write permissions.</p>

    <h3>GCS bucket name</h3>
    <p><b>Required for manually created bucket.</b> Name of GCS bucket for Climate Engine assets.
    If automatically creating the bucket and left blank, the bucket name is autogenerated (recommended).</p>

    <h3>Create Cloud SQL instance</h3>
    <p><b>Required.</b> Whether Climate Engine should automatically create a new Cloud SQL instance.
    If not automatically creating the Cloud SQL instance, it must already exist, be accessible from within GKE,
    and the username, password, database, and hostname must be specified.</p>

    <h3>Cloud SQL instance name</h3>
    <p>Optional. Name of Cloud SQL instance to create. Only used if creating new Cloud SQL instance.
    Autogenerated if not specified.</p>

    <h3>Cloud SQL unique suffix</h3>
    <p>Optional. Used to guarantee unique Cloud SQL instance name.
    Only used if creating new Cloud SQL instance and Cloud SQL instance name is not given.
    Autogenerated to a random suffix if not specified.</p>

    <h3>SQL hostname</h3>
    <p><b>Required for manually created Cloud SQL.</b> Hostname/IP address of Cloud SQL instance.
    This can be a public or private IP as long as it is accessible from within GKE. Remember to
    add the GKE network to "authorized networks" in Cloud SQL. If using Cloud SQL Proxy,
    you must manually configure and deploy this to GKE before Climate Engine.</p>
    <p><b>Must not be set if automatically creating Cloud SQL</b></p>

    <h3>SQL database</h3>
    <p><b>Required for manually created Cloud SQL.</b> Database for Climate Engine to use within
    Cloud SQL.  If Cloud SQL instance is being created automatically, the database will be automatically
    created as well.</p>

    <h3>SQL username</h3>
    <p><b>Required for manually created Cloud SQL.</b> Username for Climate Engine to use when accessing
    Cloud SQL.  If Cloud SQL instance is being created automatically, the user will be automatically
    created as well.</p>

    <h3>SQL password</h3>
    <p><b>Required for manually created Cloud SQL.</b> Password for Climate Engine to use when accessing
    Cloud SQL. If Cloud SQL instance is being created automatically, this can be manually specified,
    or left blank and it will be autogenerated (recommended).</p>

    <h3>Kubernetes Secret SA json</h3>
    <p><b>Required for automatic creation.</b> This is the name of the Kubernetes Secret containing the
    JSON credentials of a GCP Service Account with roles/owner permissions. This Service Account will be
    used to create the new resources. This service account can be deleted or disabled after deployment.</p>
    <p><i>Important:</i> This Kubernetes secret must already exist on the GKE cluster, and the JSON
    credential must be stored in a key named <i>key.json</i>. This can be created with the following command:</p>
    <p>kubectl create secret generic google-cloud-key --from-file=key.json=PATH-TO-KEY-FILE.json</p>


properties:
  app_name:
    type: string
    x-google-marketplace:
      type: NAME

  namespace:
    type: string
    x-google-marketplace:
      type: NAMESPACE

  ce-billing-agent.reporting_secret:
    type: string
    default: "fake-reporting-secret"
    x-google-marketplace:
      type: REPORTING_SECRET

  # Create new GCS Bucket?
  ce-infra-deployer.bucket_create_new:
    type: boolean
    title: "Create GCS bucket"
    description: >-
      Whether to automatically create a new cloud storage bucket for Climate Engine assets.
    default: true

  global.bucket_name:
    title: "GCS bucket name"
    description: >-
      Name of GCS bucket for Climate Engine assets. Autogenerated if not specified.
    type: string
    default: ""

  # Create new Cloud SQL?
  ce-infra-deployer.sql_create_new:
    type: boolean
    title: "Create Cloud SQL instance"
    description: >-
      Whether to automatically create a new Cloud SQL instance.
    default: true

  ce-infra-deployer.sql_instance_name:
    title: "Cloud SQL instance name"
    description: >-
      Optional. Name of Cloud SQL instance to create. Only used if creating new Cloud SQL instance.
    type: string
    default: ""

  ce-infra-deployer.sql_suffix:
    title: "Cloud SQL unique suffix"
    description: >-
      Optional. Used to guarantee unique Cloud SQL instance name.
    type: string
    x-google-marketplace:
      type: GENERATED_PASSWORD
      generatedPassword:
        length: 8
        includeSymbols: False
        base64: False

  global.postgres.host:
    title: "SQL hostname"
    description: >-
      Required for manual configuration.
    type: string
    default: ""

  global.postgres.dbname:
    title: "SQL database"
    description: >-
      Required for manual configuration.
    type: string
    default: ""

  global.postgres.user:
    title: "SQL username"
    description: >-
      Required for manual configuration.
    type: string
    default: ""

  global.postgres.password:
    title: "SQL password"
    description: >-
      Required for manual configuration. Automatically generated if blank.
    type: string
    x-google-marketplace:
      type: MASKED_FIELD

  global.sa_secret_name:
    title: "Kubernetes Secret SA json"
    description: >-
      Required for automatic configuration. See detailed instructions.
    type: string
    default: ""


required:
  - app_name
  - namespace
  - ce-billing-agent.reporting_secret
  - ce-infra-deployer.bucket_create_new
  - ce-infra-deployer.sql_create_new
  - ce-infra-deployer.sql_suffix
